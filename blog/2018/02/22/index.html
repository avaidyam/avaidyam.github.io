<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Aditya Vaidyam RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Aditya Vaidyam Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Aditya Vaidyam JSON Feed"><title data-rh="true">The Secret Life of Core Animation | Aditya Vaidyam</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aditya.vaidyam.me//logo.png"><meta data-rh="true" name="twitter:image" content="https://aditya.vaidyam.me//logo.png"><meta data-rh="true" property="og:url" content="https://aditya.vaidyam.me//blog/2018/02/22/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="The Secret Life of Core Animation | Aditya Vaidyam"><meta data-rh="true" name="description" content="Most developers know of Core Animation through its few key classes, such as CALayer and CAAnimation, and their subclasses. Very few need to venture past this realm to take advantage of this powerful framework. What&#x27;s not very clear to most is how many faces the framework takes on; there are three: CoreAnimation, CoreAnimationCF, and the internal C++ CoreAnimation underpinnings."><meta data-rh="true" property="og:description" content="Most developers know of Core Animation through its few key classes, such as CALayer and CAAnimation, and their subclasses. Very few need to venture past this realm to take advantage of this powerful framework. What&#x27;s not very clear to most is how many faces the framework takes on; there are three: CoreAnimation, CoreAnimationCF, and the internal C++ CoreAnimation underpinnings."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2018-02-22T00:00:00.000Z"><link data-rh="true" rel="icon" href="/photo.png"><link data-rh="true" rel="canonical" href="https://aditya.vaidyam.me//blog/2018/02/22/"><link data-rh="true" rel="alternate" href="https://aditya.vaidyam.me//blog/2018/02/22/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aditya.vaidyam.me//blog/2018/02/22/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2bedce02.css">
<link rel="preload" href="/assets/js/runtime~main.9507d9cb.js" as="script">
<link rel="preload" href="/assets/js/main.63fadfbd.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Aditya Vaidyam</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/">Contact</a><ul class="dropdown__menu"><li><a href="mailto:aditya@vaidyam.me" target="_blank" rel="noopener noreferrer" class="dropdown__link">Send an Email</a></li><li><a href="https://calendly.com/avaidyam/meet" target="_blank" rel="noopener noreferrer" class="dropdown__link">Schedule a Meeting</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2019/06/02/">On the debate of iOS vs. macOS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2019/02/19/">DIY: Core Animation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/03/22/">An Exercise in Modern Cocoa Views</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/03/16/">Building a Better RegisterEventHotKey</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2018/02/22/">The Secret Life of Core Animation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/02/19/">CAStateController &amp; Friends</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/02/18/">CAPortalLayer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/02/17/">CAPluginLayer &amp; CABackdropLayer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2017/10/01/">ViewBridge.framework: It works!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2016/08/05/">Picture-in-Picture on macOS Sierra</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2016/07/12/">NSExtension  &amp; PlugInKit</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">The Secret Life of Core Animation</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2018-02-22T00:00:00.000Z" itemprop="datePublished">February 22, 2018</time> Â· <!-- -->6 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Most developers know of Core Animation through its few key classes, such as <code>CALayer</code> and <code>CAAnimation</code>, and their subclasses. Very few need to venture past this realm to take advantage of this powerful framework. What&#x27;s not very clear to most is how many faces the framework takes on; there are three: <code>CoreAnimation</code>, <code>CoreAnimationCF</code>, and the internal C++ CoreAnimation underpinnings. </p><p>All three are contained within the single <code>QuartzCore.framework</code> - I&#x27;ve managed to recreate a majority (if not all) the private headers for the first two (C++ is a lot harder unfortunately), and I suggest the reader <a href="https://github.com/avaidyam/QuartzInternal" target="_blank" rel="noopener noreferrer">take a peek at them first over here.</a> For the third facet, I&#x27;ve produced a list of some, but not all, <a href="https://github.com/avaidyam/QuartzInternal/wiki/Private-CoreAnimation-CPP-Packages" target="_blank" rel="noopener noreferrer">the packages (namespaces) being used</a>, and I suggest the reader take a look at those as well.</p><p>Let&#x27;s start with the first one: the &quot;normal&quot; <code>CoreAnimation</code> - the one that runs atop Objective-C and is the only publicly marked API for any App Store apps. The easiest way to begin using it is to link AppKit or UIKit and <code>NSView</code> or <code>UIView</code> will take care of the rest for you. You just need to interface your view&#x27;s layer, animate properties as needed, and so on. There is one small indexing trick used internally called <code>CAAtom</code> --  using <code>CAAtomGetString</code> and <code>CAInternAtom</code>, you can convert between a key path (string) and an indexed id used internally. In addition to atoms, the <code>CAObject_*</code> family of functions (<code>attributesForKey/Path</code>, <code>valueForKey/Path</code>, <code>setValueForKey/Path</code>, <code>initWithCoder</code>, <code>encodeWithCoder/CAMLWriter</code>, etc) are used within <code>CALayer</code> and friends to keep track of arbitrary values for arbitrary keys. This is why you&#x27;re able to set any layer keyPath and it won&#x27;t throw a <code>valueForUndefinedKey:</code> exception. Past this, there&#x27;s not much else to see here that isn&#x27;t public.</p><p>The interesting stuff starts with <code>CoreAnimationCF</code>: it&#x27;s a barebones version of the above API... all in pure C using the <code>CoreFoundation</code> library only. You&#x27;ve got contexts, layers, rendering, and animations. If you haven&#x27;t already, take a look at the source code above. Why does this exist at all? Because Core Animation actually is cross-platform (along a few other Apple libraries, including Core Graphics)! WebKit and iTunes, for example, have existing DLLs for all of these frameworks, but since they don&#x27;t rely on Objective-C, they use the CF flavor of this API. Should a macOS/iOS developer be using this API? Really, probably not - there&#x27;s nothing you can&#x27;t do in the normal API that <code>CoreAnimationCF</code> will help you with. You&#x27;ll also notice, some API are missing, like <code>CATransaction</code>.</p><p>The final facet is the most interesting, and is pretty much a mystery to me (and remains undocumented by anyone else, AFAIK) -- the C++ API. Through one ObjC protocol (<code>CARenderValue</code>), all of the ObjC API (that is, the first facet) can be translated into the C++ API by calling <code>CA_copyRenderValue</code>). If you haven&#x27;t already, take a look at the list of packages above, because you&#x27;ll notice some striking similarities. My cursory understanding of this API is that, the render server (be it a background thread or a separate process) copies the context and its layer tree&#x27;s render values and can encode/decode them privately, relieving the ObjC/developer-facing API of any misuse or unexpected results. All of the <code>CA::Render::</code> packages/classes correspond to an ObjC layer or animation class, and once packaged up and sent over, the render server would directly manipulate these entities using the <code>CA::OGL::</code> packages/classes via a <code>SW</code> (software) renderer, <code>OGL</code> (OpenGL), or <code>Metal</code> renderer (which is likely used on all Apple platforms). In the middle, however, is <code>CA::CG::</code>, which looks like a lot of drawing routines that resemble Core Graphics (that is, <code>CGContext</code>)...</p><p>The way <code>CGContext</code> works, is that it has an internal <code>CGGState</code> stack, and a current <code>GState</code> (top of the stack), that all its clients set and manipulate via draw calls, but under the hood, <code>CGContextDelegate</code> translates these calls into a specific surface. <code>CGSWindow</code> has a <code>CGContextWindowDelegate</code> that when a <code>NSWindow</code>s (or their non-layer-backed views) need to draw, is passed as the delegate to <code>CGWindowContextCreate</code> and handles this translation layer. Similarly, a <code>CALayer</code> likely creates its context using the <code>CA::CG::</code> packages as a delegate, allowing the draw calls and GState modifications to map into whatever renderer is being currently used. </p><p>Finally, there&#x27;s one thing about both the internal C++ and public ObjC API that not many folks have documented or picked up on: <code>CATransaction</code>&#x27;s commit handlers and <code>CAContext</code>. Every process that needs to work with a layer (or more) requires at least one <code>CAContext</code> - this is where the root layer is hosted. You can create additional contexts, remote, or local, to allow hosting your layers in another process (a la Safari tabs). The context supports the notion of <code>slot</code>s and <code>fence</code>s: I presume slots are a way to pass context-related objects around remote contexts, but haven&#x27;t tested the theory. Fences, however, can be used to delay the host app&#x27;s transaction commit cycle until the client app (the one serving a remote layer) is done with its commit - essentially, it&#x27;s used to synchronize rendered frames, and a fence has a natural timeout of about one second (so the remote layer server should finish its commit within this time). This ties into transaction phases: there are a few points in a <code>CATransaction</code> that you can inject a handler: pre-layout, pre-commit, and post-commit. Combining fences with commit handlers, you can correctly synchronize remote rendered layers.</p><p>Some readers may arrive at a question here: if layers require a context, how does the context get rendered? I&#x27;m not too sure. I know there&#x27;s a way to initialize a local render server and a way to hook into a remote render server (that is, on macOS, <code>windowserver</code>), but I don&#x27;t know how the contextId makes its way over or how the two link up. However, if you&#x27;re creating a <code>CGSWindow</code>, the fast way to get a <code>CALayer</code> on-screen is to create a <code>CGSSurface</code> and bind a <code>CAView</code> to it. The header for <code>CAView</code> is incomplete, but it looks trivial to work with, as it then manages the surface for you.</p><p>So, in conclusion, there are three different facets of the Core Animation API, intricate links to Core Graphics, via <code>CGContextDelegate</code>, and some kind of <code>CARender</code> and <code>CAContext</code> song-and-dance that allows a layer to be presented on-screen or in a buffer somewhere. I hope that demystifies a lot of the private API here for you. Drop me a line on Twitter if you think anything is incorrect or needs explaining!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2018/03/16/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Building a Better RegisterEventHotKey</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2018/02/19/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">CAStateController &amp; Friends</div></a></nav></main></div></div></div></div>
<script src="/assets/js/runtime~main.9507d9cb.js"></script>
<script src="/assets/js/main.63fadfbd.js"></script>
</body>
</html>