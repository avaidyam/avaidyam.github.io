<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">DIY: Core Animation | Aditya Vaidyam</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://aditya.vaidyam.me/logo.png"><meta data-rh="true" name="twitter:image" content="https://aditya.vaidyam.me/logo.png"><meta data-rh="true" property="og:url" content="https://aditya.vaidyam.me/blog/2019/02/19/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="DIY: Core Animation | Aditya Vaidyam"><meta data-rh="true" name="description" content="(Check out the project over here.)"><meta data-rh="true" property="og:description" content="(Check out the project over here.)"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2019-02-19T00:00:00.000Z"><link data-rh="true" rel="icon" href="/photo.png"><link data-rh="true" rel="canonical" href="https://aditya.vaidyam.me/blog/2019/02/19/"><link data-rh="true" rel="alternate" href="https://aditya.vaidyam.me/blog/2019/02/19/" hreflang="en"><link data-rh="true" rel="alternate" href="https://aditya.vaidyam.me/blog/2019/02/19/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Aditya Vaidyam RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Aditya Vaidyam Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Aditya Vaidyam JSON Feed"><link rel="stylesheet" href="/assets/css/styles.c68d970c.css">
<link rel="preload" href="/assets/js/runtime~main.0ed618fb.js" as="script">
<link rel="preload" href="/assets/js/main.11747623.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Aditya Vaidyam</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/cv">CV</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/">Contact</a><ul class="dropdown__menu"><li><a href="mailto:aditya@vaidyam.me" target="_blank" rel="noopener noreferrer" class="dropdown__link">Send an Email</a></li><li><a href="https://aditya.vaidyam.me/meet" target="_blank" rel="noopener noreferrer" class="dropdown__link">Schedule a Meeting</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2019/06/02/">On the debate of iOS vs. macOS</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2019/02/19/">DIY: Core Animation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/03/22/">An Exercise in Modern Cocoa Views</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/03/16/">Building a Better RegisterEventHotKey</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/02/22/">The Secret Life of Core Animation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/02/19/">CAStateController &amp; Friends</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/02/18/">CAPortalLayer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2018/02/17/">CAPluginLayer &amp; CABackdropLayer</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2017/10/01/">ViewBridge.framework: It works!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2016/08/05/">Picture-in-Picture on macOS Sierra</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2016/07/12/">NSExtension  &amp; PlugInKit</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="description" content="(Check out the project over here.)"><header><h1 class="title_f1Hy" itemprop="headline">DIY: Core Animation</h1><div class="container_mt6G margin-vert--md"><time datetime="2019-02-19T00:00:00.000Z" itemprop="datePublished">February 19, 2019</time> Â· <!-- -->6 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p><a href="https://github.com/avaidyam/DIYAnimation" target="_blank" rel="noopener noreferrer">(Check out the project over here.)</a></p><p>After having been a consumer of the <strong>Core Animation</strong> (originally <strong>LayerKit</strong>) framework for about a decade now, I began to wonder how it was designed and implemented under the hood. Not simply the surface details such as &quot;it&#x27;s rendered out of process&quot; or &quot;it handles the animation interpolation for you&quot; or whatnot, but more specifically, <strong>HOW</strong> all of its beautiful bells and whistles translate into nitty gritty graphics ideas and associated draw calls. I figured the best way was to try to build it myself from scratch!</p><p>So I took iron to the anvil and decided to reimplement <strong>Core Animation</strong> in near-pure Swift -- that is, avoiding <code>NSObject</code>/Cocoa wherever possible. I didn&#x27;t attempt to implement the entire API surface, such as <code>CAAtom</code>, or the layout managers API (for that matter, layout managers have been remarked by Core Animation engineers as a bad idea anyways). I chose to design a closely matched, but overall Swift-ier API, such as <code>Render.Value</code>. I haven&#x27;t yet, however, implemented wrappers for all <code>Codable</code> types, partially because <strong>Core Animation</strong> is implemented in C++ and some internal types such as <code>CA::Render::Vector</code> are actually wrappers around <code>float[]</code>, for example. Implementing serialization for a <code>[Float]</code> in Swift is free, so we don&#x27;t necessarily need these wrapper types. Some facilities like <code>fence</code>s to synchronize rendering between threads or processes, or <code>slot</code>s to share drawable items (if I recall correctly), aren&#x27;t implemented yet simply because they&#x27;re not required in <strong>DIYAnimation</strong> yet. Ultimately, only the Objective-C <code>CA*</code> and the internal <code>CA::Render::*</code> API surfaces are the same, as I&#x27;ve reimplemented the actual rendering (<code>CA::OGL::*</code>) in an entirely different way atop <code>Metal</code>.</p><p>Another major departure from the C++ implementation is the use of <code>XPC</code> serialization and transport over raw <code>mach_msg</code> types and calls. While <code>XPC</code> is best known for its service and connection facilities, <strong>DIYAnimation</strong> uses the <code>xpc_pipe_t</code> object atop raw mach ports, a transport medium for serialized <code>XPC</code> objects to be passed between threads and processes which underlies <code>xpc_connection_t</code>. After writing an <code>XPC</code> encoder and decoder pair in Swift, the <code>XPCPipe</code> wrapper works with any <code>Codable</code> with some notable exceptions involving patched implementations. Though I&#x27;ve got a mach shared memory object in Swift matching the original implementation, I&#x27;m instead using <code>IOSurface</code> in a few places simply because it&#x27;s easier to work with at the moment. I&#x27;ll talk a bit more about the <code>XPC</code> internals later, but for now I&#x27;ll share a few tidbits I came across while implementing parts of <strong>DIYAnimation</strong>.</p><p>Since <strong>Core Animation</strong> doesn&#x27;t deal with accelerated 2D graphics (i.e. the now-defunct <code>QuartzGL</code> from <strong>Core Graphics</strong>), text rendering, for example, is CPU-bound -- it&#x27;s implemented in an identical manner in <strong>DIYAnimation</strong>. However, while <code>QuartzGL</code> is indeed defunct, <strong>Core Animation</strong> does actually indirectly support accelerated drawing! To make a very long story short, non-accelerated/CPU-bound drawing is performed through <code>CGContext</code> from <code>Core Graphics</code>, which is actually just a wrapper around <code>CGGState</code>, which manages the transparency layers and graphics state stack, and <code>CGContextDelegate</code>, which handles conversion of Quartz draw calls into actual rasterization. (As a side-side-note, <code>CGLayers</code> and transparency layers are essentially identical, but capture context state at different points in the drawing lifecycle.) <code>CAWindowContextDelegate</code> is the delegate used by all <code>CGContext</code>s drawing to a Cocoa window, and <code>CAIOSurfaceContextDelegate</code> is the delegate used by all <code>CGContext</code>s attached to a <code>CALayer</code> that&#x27;s currently accelerating drawing within <code>-drawInContext:</code>. It accelerates drawing by buffering its queued draw calls until its associated layer needs to draw to screen, and subsequently thereafter, its associated <code>IOSurface</code> needs to draw to screen. </p><p>I&#x27;ve attempted to replicate window server functionality as seen in <code>CAWindowServer</code> and <code>CADisplay</code>, using <code>CGS</code> windows (<code>CoreGraphicsServices</code>, now known as <code>SkyLight</code> in macOS 11+), though it&#x27;s done somewhat strangely at the moment. Not only does <code>SkyLight</code> on macOS handle event routing and layer compositing like <strong>Core Animation</strong> on iOS, but also desktop management, spaces, the menu bar, cursors, and controlling the dock, and more on macOS. That&#x27;s a lot of additional functionality that I&#x27;ll be ignoring. In <code>AppKit</code>, for example, invoking the modern drag and drop API eventually calls into <code>HIServices</code>, the vestigial <code>Carbon.framework</code> remnant underlying most of <code>AppKit</code>, which then calls into the <code>CoreDrag.framework</code>, which then creates a new <code>CGSWindow</code> with the <strong>SkyLight</strong> window server, a new <code>CAContext</code> to go with it (therefore enabling <strong>Core Animation</strong> embedding in that window), and a new root <code>CALayer</code>. That layer is then what you see while dragging a file or anything else. The actual movement of data between one process to another (<code>NSPasteboard</code> in <code>AppKit</code>) is actually implemented using <code>CFMessagePort</code> in <code>HIServices</code> - every AppKit-linked process has this port pair allocated for drag-and-drop or other pasteboard synchronization. </p><p>Speaking of <code>CGSWindow</code> and <code>CAContext</code>, by the way, these two API are actually somewhat identical in some ways. <code>AppKit</code>&#x27;s <code>NSWindow</code> wraps a <code>CGSWindow</code>, and supports on-screen drawing through providing a <code>CGContext</code> to its children <code>NSView</code>s. System events are passed from the <code>SkyLight</code> window server to the most appropriate <code>CGSWindow</code> (through a callback into the application&#x27;s run loop) which then is translated and passed to the appropriate <code>NSView</code> by that <code>NSWindow</code>. The connection to the window server, <code>CGSConnection</code> is actually explicit in all these API, and must be created by <code>AppKit</code> for each thread that wants to manage on-screen elements. Each connection is recorded by the server in an identifier-based lookup table, and upon each call to the server, its originating connection&#x27;s rights are validated for each resource modified or accessed by that call. <code>SkyLight</code> actually uses <strong>Mach Interface Generator (MIG)</strong> to marshall these calls, and connections are actually just composed of a server request mach port and an on-demand client notification/event port. In <strong>Core Animation</strong>, however, <code>CAContext</code> doesn&#x27;t handle any drawing or rendering control itself, instead delegating this to its root <code>CALayer</code>. It does control inter-context ordering (i.e. ordering root layers relative to all other on-screen root layers) and event routing when initialized connected to a remote window server instead of initialized as a local rendering context. So, CA windows (contexts) are equivalent to SkyLight windows, but while one SkyLight connection can control many windows, one CA connection may only control one CA window (context). In a way though, for quite some time now, <code>AppKit</code> internal/private API has slowly been modernized to match <strong>Core Animation</strong>, with functions like <code>NSWindowMark</code> mimicking <code>CALayerMark</code> along with the recent addition of transactions. (With <code>CGPixelAccess</code> and direct <code>CGContext</code> drawing, <code>SkyLight</code> actually has an analogous concept to <code>CABackingStore</code>; <code>CA::Shape</code> too is essentially the same as <code>CGSRegionObj</code>/<code>CGRegion</code>.)</p><p>Anyways, the next steps for this project include adding <code>CADynamicsBehavior</code> (probably hard, requiring <code>box2d</code> or <code>PhysicsKit</code> integration), <code>CAStateController</code> (likely easy), <code>CAPresentationModifier</code> (likely easy), and <code>CAML</code> and <code>CAPackage</code> support (likely easy... if using <code>NSXMLParser</code>). Though they&#x27;ve since been removed from <strong>Core Animation</strong>, <code>CALight</code> and related lighting filters did used to exist, roughly matching SVG&#x27;s <code>feDiffuseLighting</code> and <code>feSpecularLighting</code>, for example. They were meant to be used with <code>CAMeshTransform</code>, which is also currently unimplemented. In summary, as you can see, there&#x27;s a lot of private and some public API that are yet unimplemented, even though the groundwork has been laid. Take a look at the implementation details -- I&#x27;m sure you&#x27;ll find them interesting, as they&#x27;re mostly faithful to the original (decompiled) C++ implementation!</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2019/06/02/"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">On the debate of iOS vs. macOS</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2018/03/22/"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">An Exercise in Modern Cocoa Views</div></a></nav></main></div></div></div></div>
<script src="/assets/js/runtime~main.0ed618fb.js"></script>
<script src="/assets/js/main.11747623.js"></script>
</body>
</html>