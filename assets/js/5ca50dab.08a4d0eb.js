"use strict";(self.webpackChunkAditya_Vaidyam=self.webpackChunkAditya_Vaidyam||[]).push([[308],{2163:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(8168),r=(n(6540),n(5680));const i={},o="CAStateController & Friends",l={permalink:"/blog/2018/02/19/",source:"@site/blog/2018-02-19.md",title:"CAStateController & Friends",description:"CALayer has internal/private support for two pretty cool things: archives and states. We'll talk about states first, as they're the more complex part of the exercise.",date:"2018-02-19T00:00:00.000Z",formattedDate:"February 19, 2018",tags:[],readingTime:3.49,hasTruncateMarker:!0,authors:[],frontMatter:{},prevItem:{title:"The Secret Life of Core Animation",permalink:"/blog/2018/02/22/"},nextItem:{title:"CAPortalLayer",permalink:"/blog/2018/02/18/"}},s={authorsImageUrls:[]},p=[],y={toc:p},c="wrapper";function d(e){let{components:t,...n}=e;return(0,r.yg)(c,(0,a.A)({},y,n,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("p",null,(0,r.yg)("inlineCode",{parentName:"p"},"CALayer")," has internal/private support for two pretty cool things: archives and states. We'll talk about states first, as they're the more complex part of the exercise. "),(0,r.yg)("p",null,"A ",(0,r.yg)("inlineCode",{parentName:"p"},"CALayer")," can have any number of ",(0,r.yg)("inlineCode",{parentName:"p"},"states")," which are ",(0,r.yg)("inlineCode",{parentName:"p"},"CAState")," objects containing a number of ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateElement"),"s. The elements configure the state, and can ",(0,r.yg)("inlineCode",{parentName:"p"},"target")," any sublayer of the root layer, and any ",(0,r.yg)("inlineCode",{parentName:"p"},"keyPath")," on ",(0,r.yg)("inlineCode",{parentName:"p"},"CALayer"),". It looks like it can also have a ",(0,r.yg)("inlineCode",{parentName:"p"},"source")," (which is a ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateElement")," itself) but I'm not sure what that specifically means. A state can also be ",(0,r.yg)("inlineCode",{parentName:"p"},"basedOn")," another ",(0,r.yg)("inlineCode",{parentName:"p"},"CAState"),", presumably one that preceeds it in the state diagram of the layer; an ",(0,r.yg)("inlineCode",{parentName:"p"},"initial")," state is one that a layer can start off with (and doesn't need a ",(0,r.yg)("inlineCode",{parentName:"p"},"name")," to uniquely identify it). On top of that, a ",(0,r.yg)("inlineCode",{parentName:"p"},"CALayer")," may also have a number of ",(0,r.yg)("inlineCode",{parentName:"p"},"stateTransitions")," which are ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateTransition")," objects (containing ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateTransitionElement"),"s). The typical use case will be to create elements with a ",(0,r.yg)("inlineCode",{parentName:"p"},"target")," and an ",(0,r.yg)("inlineCode",{parentName:"p"},"animation")," representing the ",(0,r.yg)("inlineCode",{parentName:"p"},"keyPath")," that needs to be animated between the two states. Be sure to set the ",(0,r.yg)("inlineCode",{parentName:"p"},"toState")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"fromState")," on your transition to match the unique state ",(0,r.yg)("inlineCode",{parentName:"p"},"name"),"s from earlier. If you use the string ",(0,r.yg)("inlineCode",{parentName:"p"},'"*"'),", I believe it refers to any possible state. Here's a code sample:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-swift"},'let s1 = CAState()\ns1.name = "inactive"\ns1.isInitial = true\nlet e1 = CAStateSetValue()\ne1.keyPath = "backgroundColor"\ne1.value = NSColor.red.cgColor\ne1.target = layer\ns1.addElement(e1)\n\nlet s2 = CAState()\ns2.name = "active"\nlet e2 = CAStateSetValue()\ne2.keyPath = "backgroundColor"\ne2.value = NSColor.blue.cgColor\ne2.target = layer\ns2.addElement(e2)\n\nlet t1 = CAStateTransition()\nt1.fromState = "*"\nt1.toState = "active"\nlet e3 = CAStateTransitionElement()\ne3.key = "backgroundColor"\ne3.animation = CABasicAnimation(keyPath: "backgroundColor")\ne3.target = layer\ne3.isEnabled = true\ne3.duration = 2.0\nt1.elements = [e3]\n\nlet t2 = CAStateTransition()\nt1.fromState = "*"\nt1.toState = "inactive"\nlet e4 = CAStateTransitionElement()\ne4.key = "backgroundColor"\ne4.animation = CABasicAnimation(keyPath: "backgroundColor")\ne4.target = layer\ne4.isEnabled = true\ne4.duration = 2.0\nt2.elements = [e4]\n\nlet t3 = CAStateTransition()\nt3.fromState = "inactive"\nt3.toState = "active"\nlet e5 = CAStateTransitionElement()\ne5.key = "backgroundColor"\ne5.animation = CABasicAnimation(keyPath: "backgroundColor")\ne5.target = layer\ne5.isEnabled = true\ne5.duration = 2.0\nt3.elements = [e5]\n\nlet t4 = CAStateTransition()\nt4.fromState = "active"\nt4.toState = "inactive"\nlet e6 = CAStateTransitionElement()\ne6.key = "backgroundColor"\ne6.animation = CABasicAnimation(keyPath: "backgroundColor")\ne6.target = layer\ne6.isEnabled = true\ne6.duration = 2.0\nt4.elements = [e6]\n\nlayer.states = [s1, s2]\nlayer.stateTransitions = [t1, t2, t3, t4]\n\nDispatchQueue.main.asyncAfter(deadline: .now() + .seconds(1)) {\n    self.ctrl = CAStateController(layer: layer)!\n    self.ctrl.setInitialStatesOfLayer(layer, transitionSpeed: 0.5)\n    \n    DispatchQueue.main.asyncAfter(deadline: .now() + .seconds(1)) {\n        self.ctrl.setState(s2, ofLayer: layer, transitionSpeed: 0.5)\n    }\n}\n')),(0,r.yg)("p",null,"To actually apply and modify states on a layer, you'll want to create a ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateController"),". It's simple to use, as you initially call ",(0,r.yg)("inlineCode",{parentName:"p"},"setInitialStatesOfLayer(_:)"),"  and to change a state, call ",(0,r.yg)("inlineCode",{parentName:"p"},"setState(ofLayer:)"),". If you include the ",(0,r.yg)("inlineCode",{parentName:"p"},"transitionSpeed")," argument, it'll set a duration for any possible transitions to occur (independently of the duration of its ",(0,r.yg)("inlineCode",{parentName:"p"},"element"),"s)."),(0,r.yg)("p",null,"I don't recommend using ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateController")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"CAState")," without having written a good CoreAnimation \"Interface Builder\" to help you design states and layers correctly. Since Apple likely has this tool and we don't, it's probably why the API is private at the moment. A first step towards this, however, is to use ",(0,r.yg)("inlineCode",{parentName:"p"},"CAML")," packages correctly. There is a ",(0,r.yg)("inlineCode",{parentName:"p"},"CAPackage")," class to aid in all of this, but we'll use ",(0,r.yg)("inlineCode",{parentName:"p"},"CAMLWriter")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"CAMLParser")," instead, which mirror ",(0,r.yg)("inlineCode",{parentName:"p"},"NSKeyedArchiver")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"NSKeyedUnarchiver"),', but serialize into a "core animation archive" (caar) which uses a different XML format. Here\'s a code sample:'),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-swift"},"// Write:\nlet data = NSMutableData()\nlet writer = CAMLWriter(data: data)\nwriter?.encode(layer)\n\n// Read:\nlet parser = CAMLParser()\n_ = parser.parseData(data as Data)\nlet layer2 = parser.result as! CALayer\n")),(0,r.yg)("p",null,"Pretty simple right!? Now the challenge is to build an interface designer to model ",(0,r.yg)("inlineCode",{parentName:"p"},"CALayer"),"s and ",(0,r.yg)("inlineCode",{parentName:"p"},"CAState"),"s. Encode it into a ",(0,r.yg)("inlineCode",{parentName:"p"},"caml")," file and decode it at runtime, and you're all set. Use a ",(0,r.yg)("inlineCode",{parentName:"p"},"CAPackage")," to neatly wrap the loading logic -- check out ",(0,r.yg)("inlineCode",{parentName:"p"},"AVMicaPackage")," in AVKit, some of the packages in DictationServices (within PrivateFrameworks/SpeechObjects), or PassKitUIFoundation."),(0,r.yg)("p",null,"Regarding ",(0,r.yg)("inlineCode",{parentName:"p"},"CAState"),", I'm still not sure what ",(0,r.yg)("inlineCode",{parentName:"p"},"CAState.locked"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateElement.source"),", ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateControllerLayer")," (which isn't even a ",(0,r.yg)("inlineCode",{parentName:"p"},"CALayer")," subclass??) or ",(0,r.yg)("inlineCode",{parentName:"p"},"CAStateControllerUndo")," (and related ",(0,r.yg)("inlineCode",{parentName:"p"},"undoStack"),") do. I'll investigate those but if anyone has any idea, drop me a line and let me know!"))}d.isMDXComponent=!0},5680:(e,t,n)=>{n.d(t,{xA:()=>y,yg:()=>u});var a=n(6540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},y=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,y=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,u=c["".concat(s,".").concat(m)]||c[m]||d[m]||i;return n?a.createElement(u,o(o({ref:t},y),{},{components:n})):a.createElement(u,o({ref:t},y))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);